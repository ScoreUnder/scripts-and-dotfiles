#!/bin/sh
_prog_name=${0##*/}
die() { printf "%s: %s" "$_prog_name" "$*" >&2; exit 1; }
[ "$#" != 0 ] || die "Need a dir to transcode"

reencode_file() {
    file=$1
    fbase=${file##*/}
    [ "$fbase" = . -o "$fbase" = .. ] && return
    [ -e "$file" ] || return

    if [ "${fbase##*.}" = flac ]
    then ffmpeg -i "$file" -q:a 6 -vn "$base/${fbase%.flac}.ogg"
    else cp -r --reflink=auto "$file" "$base/$fbase"
    fi
}

if [ "$1" = --single-internal ]; then
    shift
    reencode_file "$@"
    exit
fi

for dir do
    [ -r "$dir" ] || die "No read access: $dir"
    [ -d "$dir" ] || die "Not a directory: $dir"
    export base="$(basename -- "$dir")"
    mkdir -p -- "$base"
    parallel -q --bar "$0" --single-internal {} ::: "$dir"/* "$dir"/.* </dev/null
done
